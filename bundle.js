(()=>{"use strict";(()=>{const e=["Апартаменты-студия","Аппартаменты в центре","Дом за городом","Малокомнатная квартира","Многокомнатная квартира","Несколькокомнатная квартира"],t=["palace","flat","house","bungalow"],o=["12:00","13:00","14:00"],r=["wifi","dishwasher","parking","washer","elevator","conditioner"],n=["Новостройка расположена в Ценратральном районе, на территории национального парка.","Охраняемая территория, система контроля управления доступом в т.ч. по смартфону. Есть подземный паркинг.","Собственная инфраструктура: детский сад, детская площадка, тир, тренажерный зал, бассейн, спортивно-оздоровительный комплекс, собственное футбольное поле, магазины, салоны красоты, сауны, массажный и косметический салоны и т.д.","Очень престижный район, инфраструктура мегаполиса и тихий двор, большой плюс, что 2 из 3х балконов находятся в данных комнатах."],s=["http://o0.github.io/assets/images/tokyo/hotel1.jpg","http://o0.github.io/assets/images/tokyo/hotel2.jpg","http://o0.github.io/assets/images/tokyo/hotel3.jpg"],a=document.querySelector(".map"),c=(e,t)=>Math.round(Math.random()*(t-e))+e,i=e=>e[Math.floor(Math.random()*e.length)],l=()=>{const l={x:c(0,a.offsetWidth),y:c(130,630)};return{author:{avatar:`img/avatars/user0${c(1,8)}.png`},offer:{title:i(e),address:`${l.x}, ${l.y}`,price:(d=c(1e4,1e5),1e3*Math.round(d/1e3)),type:i(t),rooms:c(1,10),guests:c(1,15),checkin:i(o),checkout:i(o),features:r.slice(0,c(0,r.length)),description:i(n),photos:i(s)},location:l};var d};window.adverts={list:e=>{const t=[];for(let o=0;o<e;o++)t.push(l());return t},quantity:8}})(),(()=>{const e="https://21.javascript.pages.academy/keksobooking/data",t="https://21.javascript.pages.academy/keksobooking";window.backend={getAdverts:(t,o)=>{const r=new XMLHttpRequest;r.responseType="json",r.addEventListener("load",(()=>{200===r.status?t(r.response):o(`Статус ответа:  ${r.status} ${r.statusText}`)})),r.addEventListener("error",(()=>{o(`Запрос не успел выполниться за ${r.timeout}мс`)})),r.timeout=1e4,r.open("GET",e),r.send()},sendUserData:(e,o,r)=>{const n=new XMLHttpRequest;n.responseType="json",n.addEventListener("load",(()=>{200===n.status?o(n.response):r(`Статус ответа:  ${n.status} ${n.statusText}`)})),n.open("POST",t),n.send(e)}}})(),(()=>{let e=null;window.debounce=t=>{e&&window.clearTimeout(e),e=window.setTimeout(t,500)}})(),(()=>{const e=document.querySelector(".ad-form"),t=e.querySelector("#title");window.setFieldStatus=(e,t)=>{e.forEach((e=>{e.disabled=t}))},t.addEventListener("invalid",(()=>{t.validity.tooShort?t.setCustomValidity("Минимальная длина заголовка — 30 символов"):t.validity.tooLong?t.setCustomValidity("Максимальная длина заголовка — 100 символов"):t.validity.valueMissing?t.setCustomValidity("Заголовок объявления обязателен для заполнения"):t.setCustomValidity("")}));const o=e.querySelector("#price");o.addEventListener("invalid",(()=>{o.validity.rangeOverflow?(o.setCustomValidity("Максимальная сумма 1 000 000"),o.value=1e6):o.setCustomValidity("")}));const r={bungalow:0,flat:1e3,house:5e3,palace:1e4};e.querySelector("#type").addEventListener("change",(e=>{var t;t=e.target.value,o.setAttribute("min",r[t]),o.setAttribute("placeholder",r[t])}));const n={1:[1],2:[1,2],3:[1,2,3],100:[0]},s=e.querySelector("#capacity").querySelectorAll("option");window.setRooms=e=>{s.forEach((e=>{e.disabled=!0})),n[e].forEach((e=>{s.forEach((t=>{Number(t.value)===e&&(t.disabled=!1,t.selected=!0)}))}))};const a=e.querySelector("#timein"),c=a.querySelectorAll("option"),i=e.querySelector("#timeout"),l=i.querySelectorAll("option"),d=e=>{c.forEach((t=>{l.forEach((o=>{e.target.value===t.value&&e.target.value===o.value&&(t.selected=!0,o.selected=!0)}))}))};a.addEventListener("change",(e=>{d(e)})),i.addEventListener("change",(e=>{d(e)}));const u=document.querySelector("main"),p=(e,t)=>{window.util.isMouseDown(e,(()=>t.remove()))},m=(e,t)=>{window.util.isEscEvt(e,(()=>t.remove())),document.removeEventListener("keydown",f),document.removeEventListener("keydown",w)},y=e=>{const t=u.querySelector(".success");p(e,t)},f=e=>{const t=u.querySelector(".success");m(e,t)},v=e=>{const t=u.querySelector(".error");p(e,t)},w=e=>{const t=u.querySelector(".error");m(e,t)},h=()=>{const e=document.querySelector("#success").content.querySelector(".success").cloneNode(!0);u.appendChild(e),_(),document.addEventListener("keydown",f),e.addEventListener("click",y)},S=()=>{const e=document.querySelector("#error").content.querySelector(".error").cloneNode(!0);u.appendChild(e),e.addEventListener("click",v),document.addEventListener("keydown",w)};e.addEventListener("submit",(t=>{window.backend.sendUserData(new FormData(e),h,S),t.preventDefault()}));const q=document.querySelector(".map__pin--main"),_=()=>{e.reset(),window.map.getPinLocation(q)};e.querySelector(".ad-form__reset").addEventListener("click",(e=>{e.preventDefault(),_()}))})(),(()=>{const e=document.querySelector(".map__pins"),t=document.querySelector(".map"),o=document.querySelector(".ad-form"),r=t.querySelector(".map__filters"),n=o.querySelectorAll("fieldset"),s=r.querySelectorAll("select"),a=o.querySelector("#address"),c=e.querySelector(".map__pin--main"),i=c.offsetWidth,l=c.offsetHeight,d=e=>{const t=Math.floor(parseInt(e.style.left,10)-i/2),o=Math.floor(parseInt(e.style.top,10)-l/2+22);a.value=`${t}, ${o}`};window.map={renderPins:e=>{window.util.isMouseDown(e,(()=>{window.setFieldStatus(n,!1),window.setFieldStatus(s,!1),o.classList.remove("ad-form--disabled"),t.classList.remove("map--faded"),window.backend.getAdverts(window.pin.successHandler,window.pin.errorHandler),d(c),c.removeEventListener("click",window.map.renderPins)}))},getPinLocation:d}})(),window.util={isEscEvt:(e,t)=>{"Escape"===e.key&&t()},isEnterEvt:(e,t)=>{"Enter"===e.key&&t()},isMouseDown:(e,t)=>{1===e.which&&t()},errorHandler:e=>{const t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: tomato;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="40px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)}},(()=>{const e=document.querySelector(".map__pins").querySelector(".map__pin--main"),t=document.querySelector(".map"),o=document.querySelector(".ad-form"),r=t.querySelector(".map__filters"),n=o.querySelectorAll("fieldset"),s=r.querySelectorAll("select");window.setFieldStatus(n,!0),window.setFieldStatus(s,!0),e.addEventListener("click",window.map.renderPins),o.querySelector("#room_number").addEventListener("change",(e=>{window.setRooms(e.target.value)}))})(),(()=>{const e=document.querySelector("#pin").content,t=document.querySelector(".map__pins");let o=[];const r=t=>{const o=e.cloneNode(!0),r=o.querySelector(".map__pin"),n=o.querySelector("img");return r.style.left=t.location.x-r.offsetWidth+"px",r.style.top=t.location.y-r.offsetHeight+"px",n.src=t.author.avatar,n.alt=t.offer.title,r.addEventListener("click",(()=>{window.card.renderCard(window.card.createCard(t))})),o},n=()=>{let e=t.querySelectorAll(".map__pin");for(let t=1;t<e.length;t++)e[t].remove()},s=()=>{n(),(e=>{window.fragment=document.createDocumentFragment();for(let t=0;t<e.length;t++)window.fragment.appendChild(r(e[t]));t.appendChild(window.fragment)})(o.filter(window.filter.applyFilter).slice(0,5))};document.querySelector(".map__filters").addEventListener("change",(()=>{n(),window.debounce(s)})),window.pin={updatePinsList:s,successHandler:e=>{o=e,s()},errorHandler:e=>{window.util.errorHandler(e)}}})(),(()=>{const e=document.querySelector(".map__filters"),t=e.querySelector("#housing-type"),o=e.querySelector("#housing-price"),r=e.querySelector("#housing-rooms"),n=e.querySelector("#housing-guests"),s=e.querySelector("#housing-features");window.filter={applyFilter:e=>(e=>"any"===t.value||t.value===e.offer.type)(e)&&(e=>"any"===o.value||("low"===o.value?e.offer.price<1e4:"middle"===o.value?e.offer.price>1e4&&e.offer.price<=5e4:"high"===o.value&&e.offer.price>=5e4))(e)&&(e=>"any"===r.value||parseInt(r.value,10)===e.offer.rooms)(e)&&(e=>"any"===n.value||parseInt(n.value,10)===e.offer.quests)(e)&&(e=>Array.from(s.querySelectorAll(".map__checkbox:checked")).map((e=>e.value)).every((t=>e.offer.features.includes(t))))(e)}})(),(()=>{const e={flat:"Квартира",bungalow:"Бунгало",house:"Дом",palace:"Дворец"},t=document.querySelector(".map"),o=document.querySelector("#card").content.querySelector(".map__card"),r=document.querySelector("#photo").content.querySelector("img"),n=e=>{const o=t.querySelector(".popup");window.util.isMouseDown(e,(()=>o.remove())),document.removeEventListener("keydown",s)},s=e=>{const o=t.querySelector(".popup");window.util.isEscEvt(e,(()=>o.remove())),document.removeEventListener("keydown",s)};window.card={createCard:t=>{const n=o.cloneNode(!0),s=n.querySelector(".popup__avatar"),a=n.querySelector(".popup__title"),c=n.querySelector(".popup__text--address"),i=n.querySelector(".popup__text--price"),l=n.querySelector(".popup__type"),d=n.querySelector(".popup__text--capacity"),u=n.querySelector(".popup__text--time"),p=n.querySelector(".popup__features"),m=n.querySelector(".popup__description"),y=n.querySelector(".popup__photos");return s.src=t.author.avatar,a.textContent=t.offer.title,c.textContent=t.offer.address,i.textContent=t.offer.price+"₽/ночь",l.textContent=e[t.offer.type],d.textContent=`${t.offer.rooms} комнаты для ${t.offer.guests} гостей`,u.textContent=`Заезд после ${t.offer.checkin}, выезд до ${t.offer.checkout}`,p.innerHTML="",t.offer.features.forEach((e=>{const t=((e,t)=>{const o=document.createElement("li");return o.classList.add("popup__feature","popup__feature--"+t),o})(0,e);p.appendChild(t)})),y.innerHTML="",y.appendChild((e=>{const t=document.createDocumentFragment();return e.offer.photos.forEach((e=>{const o=r.cloneNode(!0);o.src=e,t.appendChild(o)})),t})(t)),m.textContent=t.offer.description,n},renderCard:e=>{const o=document.createDocumentFragment(),r=t.querySelector(".popup");r&&r.remove(),o.appendChild(e),o.querySelector(".popup__close").addEventListener("click",n),document.addEventListener("keydown",s),t.appendChild(o)}}})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__pin--main"),o={TOP_Y:130,BOTTOM_Y:630,LEFT_X:0-t.offsetWidth/2,RIGHT_X:e.offsetWidth-t.offsetWidth/2};t.addEventListener("mousedown",(r=>{r.preventDefault();let n={x:r.clientX,y:r.clientY},s=!1;const a=e=>{e.preventDefault(),s=!0;const r=n.x-e.clientX,a=n.y-e.clientY;n={x:e.clientX,y:e.clientY};let c=t.offsetTop-a,i=t.offsetLeft-r;c<o.TOP_Y?c=o.TOP_Y:c>o.BOTTOM_Y&&(c=o.BOTTOM_Y),i<o.LEFT_X?i=o.LEFT_X:i>o.RIGHT_X&&(i=o.RIGHT_X),t.style.top=c+"px",t.style.left=i+"px",window.map.getPinLocation(t)},c=e=>{if(e.preventDefault(),document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",c),s){const e=o=>{o.preventDefault(),t.removeEventListener("click",e)};t.addEventListener("click",e)}};e.classList.contains("map--faded")||(document.addEventListener("mousemove",a),document.addEventListener("mouseup",c))}))})(),(()=>{const e=["image/gif","image/jpg","image/jpeg","image/png"],t=document.querySelector(".ad-form"),o=t.querySelector(".ad-form__field input[type=file]"),r=t.querySelector(".ad-form-header__preview img"),n=t.querySelector(".ad-form__upload input[type=file]"),s=t.querySelector(".ad-form__photo img"),a=(t,o)=>{const r=t.files[0],n=r.type;if(e.some((e=>n===e))){const e=new FileReader;e.addEventListener("load",(()=>{o.src=e.result})),e.readAsDataURL(r)}};o.addEventListener("change",(()=>{a(o,r)})),n.addEventListener("change",(()=>{a(n,s)}))})()})();